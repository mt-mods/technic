name: busted

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: apt
      run: sudo apt-get install -y luarocks
    - name: busted install
      run: |
        luarocks install --local busted
        luarocks install --local cluacov
    - name: busted run
      working-directory: ./technic
      run: |
        $HOME/.luarocks/bin/busted -c
        (printf coverage=>>$GITHUB_ENV;tail -n 2 luacov.report.out | grep ^Total | grep -o '[0-9.]\+%$'>>$GITHUB_ENV)
    - name: Test coverage badge
      uses: RubbaBoy/BYOB@v1.2.0
      with:
        NAME: coverage
        LABEL: 'Coverage'
        STATUS: ${{ env.coverage }}
        COLOR: 99CC09
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
